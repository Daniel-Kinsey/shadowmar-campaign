<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronicles of Shadowmar - D&D Campaign</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <h1>‚öîÔ∏è Chronicles of Shadowmar</h1>
                <div class="header-controls">
                    <span id="username-display">{{ session.username }}</span>
                    <span class="role-badge" id="role-badge">{{ session.role }}</span>
                    <button id="logout-btn" class="btn btn-secondary">Logout</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <!-- Tab Navigation -->
                <nav class="tabs">
                    <button class="tab-btn active" data-tab="characters">Characters</button>
                    <button class="tab-btn" data-tab="campaign">Campaign</button>
                    <button class="tab-btn" data-tab="chat">Chat</button>
                    <button class="tab-btn" data-tab="files">Files</button>
                    <button class="tab-btn" data-tab="dm-book">üìñ DM Book</button>
                </nav>

                <!-- Characters Tab -->
                <div id="characters-tab" class="tab-content active">
                    <div class="tab-header">
                        <h2>Characters</h2>
                        <button id="add-character-btn" class="btn btn-primary">+ Add Character</button>
                    </div>
                    
                    <div id="characters-grid" class="characters-grid">
                        <!-- Characters will be loaded here -->
                    </div>

                    <!-- Character Modal -->
                    <div id="character-modal" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 id="character-modal-title">Add Character</h3>
                                <span class="close">&times;</span>
                            </div>
                            <div class="modal-body">
                                <form id="character-form">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="char-name">Character Name</label>
                                            <input type="text" id="char-name" name="name" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="char-class">Class</label>
                                            <input type="text" id="char-class" name="class">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="char-level">Level</label>
                                            <input type="number" id="char-level" name="level" min="1" max="20" value="1">
                                        </div>
                                        <div class="form-group">
                                            <label for="char-ac">Armor Class</label>
                                            <input type="number" id="char-ac" name="ac" min="1" value="10">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="char-hp-current">Current HP</label>
                                            <input type="number" id="char-hp-current" name="hp_current" min="0" value="10">
                                        </div>
                                        <div class="form-group">
                                            <label for="char-hp-max">Max HP</label>
                                            <input type="number" id="char-hp-max" name="hp_max" min="1" value="10">
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="char-notes">Notes</label>
                                        <textarea id="char-notes" name="notes" rows="4" placeholder="Character backstory, equipment, etc."></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" id="cancel-character" class="btn btn-secondary">Cancel</button>
                                <button type="button" id="save-character" class="btn btn-primary">Save Character</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Campaign Tab -->
                <div id="campaign-tab" class="tab-content">
                    <div class="tab-header">
                        <h2>Campaign Information</h2>
                    </div>
                    
                    <div class="campaign-sections">
                        <div class="campaign-section">
                            <h3>Current Location</h3>
                            <div class="editable-field" data-field="location">
                                <span class="field-content">Loading...</span>
                                <button class="edit-btn">Edit</button>
                            </div>
                        </div>
                        
                        <div class="campaign-section">
                            <h3>Session Notes</h3>
                            <div class="editable-field" data-field="session_notes">
                                <div class="field-content">Loading...</div>
                                <button class="edit-btn">Edit</button>
                            </div>
                        </div>
                        
                        <div class="campaign-section">
                            <h3>Important NPCs</h3>
                            <div class="editable-field" data-field="npcs">
                                <div class="field-content">Loading...</div>
                                <button class="edit-btn">Edit</button>
                            </div>
                        </div>
                        
                        <div class="campaign-section">
                            <h3>Treasure & Loot</h3>
                            <div class="editable-field" data-field="treasure">
                                <div class="field-content">Loading...</div>
                                <button class="edit-btn">Edit</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Tab -->
                <div id="chat-tab" class="tab-content">
                    <div class="chat-container">
                        <div id="chat-messages" class="chat-messages">
                            <!-- Messages will be loaded here -->
                        </div>
                        
                        <div class="chat-input-container">
                            <input type="text" id="chat-input" placeholder="Type your message..." maxlength="500">
                            <button id="send-message" class="btn btn-primary">Send</button>
                        </div>
                    </div>
                </div>

                <!-- Files Tab -->
                <div id="files-tab" class="tab-content">
                    <div class="tab-header">
                        <h2>Campaign Files</h2>
                        <div class="file-upload-container">
                            <input type="file" id="file-input" accept=".txt,.pdf,.png,.jpg,.jpeg,.gif,.doc,.docx" style="display: none;">
                            <button id="upload-btn" class="btn btn-primary">Upload File</button>
                        </div>
                    </div>
                    
                    <div id="files-list" class="files-list">
                        <!-- Files will be loaded here -->
                    </div>
                </div>

                <!-- DM Book Tab -->
                <div id="dm-book-tab" class="tab-content">
                    <div class="tab-header">
                        <h2>üìñ Chronicles of Shadowmar: DM's Compendium</h2>
                    </div>
                    
                    <div class="dm-book-container">
                        <div class="book-navigation">
                            <h3>Table of Contents</h3>
                            <ul class="book-chapters">
                                <li><button class="chapter-btn active" data-section="overview">üåä World Overview</button></li>
                                <li><button class="chapter-btn" data-section="sessions">üìú Session Archive</button></li>
                                <li><button class="chapter-btn" data-section="xylos">üèõÔ∏è The Drowned City</button></li>
                                <li><button class="chapter-btn" data-section="npcs">üë• NPCs of Xylos</button></li>
                                <li><button class="chapter-btn" data-section="encounters">‚öîÔ∏è Encounters & Combat</button></li>
                                <li><button class="chapter-btn" data-section="lore">üìö World Lore & Secrets</button></li>
                                <li><button class="chapter-btn" data-section="tools">üîß DM Tools & Reference</button></li>
                            </ul>
                        </div>
                        
                        <div class="book-content">
                            <div class="book-page">
                                <div id="book-chapter-content">
                                    <div class="loading-book">Loading the ancient tome...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dice Tab -->
                <div id="dice-tab" class="tab-content">
                    <div class="tab-header">
                        <h2>Dice Roller</h2>
                    </div>
                    
                    <div class="dice-container">
                        <div class="dice-controls">
                            <div class="form-group">
                                <label for="dice-type">Dice Type</label>
                                <select id="dice-type">
                                    <option value="d4">d4</option>
                                    <option value="d6">d6</option>
                                    <option value="d8">d8</option>
                                    <option value="d10">d10</option>
                                    <option value="d12">d12</option>
                                    <option value="d20" selected>d20</option>
                                    <option value="d100">d100</option>
                                    <option value="2d6">2d6</option>
                                    <option value="3d6">3d6</option>
                                    <option value="4d6">4d6</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="dice-modifier">Modifier</label>
                                <input type="number" id="dice-modifier" value="0" min="-10" max="20">
                            </div>
                            
                            <div class="form-group">
                                <label for="dice-reason">Reason (optional)</label>
                                <input type="text" id="dice-reason" placeholder="Attack roll, Perception check, etc.">
                            </div>
                        </div>
                        
                        <button id="roll-dice" class="btn btn-primary btn-large">üé≤ Roll Dice</button>
                        
                        <div class="quick-rolls">
                            <h3>Quick Rolls</h3>
                            <div class="quick-roll-buttons">
                                <button class="btn btn-secondary quick-roll" data-dice="d20" data-reason="Attack Roll">Attack</button>
                                <button class="btn btn-secondary quick-roll" data-dice="d20" data-reason="Saving Throw">Save</button>
                                <button class="btn btn-secondary quick-roll" data-dice="d20" data-reason="Skill Check">Skill</button>
                                <button class="btn btn-secondary quick-roll" data-dice="d6" data-reason="Damage">d6 Damage</button>
                                <button class="btn btn-secondary quick-roll" data-dice="d8" data-reason="Damage">d8 Damage</button>
                                <button class="btn btn-secondary quick-roll" data-dice="4d6" data-reason="Ability Score">4d6 Stats</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Field Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="edit-modal-title">Edit Field</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <textarea id="edit-textarea" rows="6"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" id="cancel-edit" class="btn btn-secondary">Cancel</button>
                <button type="button" id="save-edit" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- Notification Container -->
    <div id="notifications" class="notifications"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>

    <!-- TEMPORARY DEBUG SCRIPT -->
<script>
console.log('=== DM BOOK DEBUG ===');

// Test 1: Check if elements exist
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded');
    
    const dmBookTab = document.querySelector('[data-tab="dm-book"]');
    const dmBookContent = document.getElementById('dm-book-tab');
    const chapterContent = document.getElementById('book-chapter-content');
    
    console.log('DM Book tab button:', dmBookTab);
    console.log('DM Book content area:', dmBookContent);
    console.log('Chapter content area:', chapterContent);
    
    // Test 2: Add click handler
    if (dmBookTab) {
        dmBookTab.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('DM Book tab clicked!');
            
            // Show the tab
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            dmBookContent.classList.add('active');
            dmBookTab.classList.add('active');
            
            // Load content
            testLoadContent();
        });
    } else {
        console.error('DM Book tab button not found!');
    }
});

// Test 3: Load content function
async function testLoadContent() {
    console.log('Loading content...');
    const content = document.getElementById('book-chapter-content');
    
    if (!content) {
        console.error('book-chapter-content element not found!');
        return;
    }
    
    content.innerHTML = '<div class="loading-book">Loading test...</div>';
    
    try {
        const response = await fetch('/api/dm/book/overview');
        console.log('API Response status:', response.status);
        
        const data = await response.json();
        console.log('API Data:', data);
        
        if (response.ok) {
            content.innerHTML = `<h2>${data.title}</h2>${data.content}`;
            console.log('Content loaded successfully!');
        } else {
            content.innerHTML = `<p>Error: ${data.error}</p>`;
        }
    } catch (error) {
        console.error('Fetch error:', error);
        content.innerHTML = `<p>Network error: ${error.message}</p>`;
    }
}
</script>
<!-- END DEBUG SCRIPT -->
</body>
</html>
